\section{Dafny VSCode}
Github Repository: \href{https://github.com/FunctionalCorrectness/dafny-vscode}{https://github.com/FunctionalCorrectness/dafny-vscode}

\subsection{Overview}
\todo{Maybe add a class diagram}

\subsection{VSCode Plugin}
\subsubsection{Structure}
\todo{How is a vscode plugin structured, package.json explaination}


\input{sections/languageserver}

\subsection{Extension points}

\paragraph{Statusbar}

\paragraph{Refactoring}

\paragraph{CodeLens}

\paragraph{Go to definition}

\paragraph{Debugger}
\todo{Boogie Verification Debugger: Why BVD can't be used directly: C sharp UI, }

\subsection{Communication}

\subsection{Sytax highlighting}

\subsection{Snippets}

\subsection{Automatic installation}
\subsubsection{Windows}

\subsubsection{Ubuntu}

\subsubsection{OSX}


\subsection{DafnyServer}
Github Repository: \href{https://github.com/FunctionalCorrectness/dafny-microsoft}{https://github.com/FunctionalCorrectness/dafny-microsoft}

The DafnyServer is a simple console application which allows proofing Dafny source files. To verify documents, they are sent over the standard input. Results are obtained from the standard output. The verification task needs to be in json format \todo{add reference to source.cs} and is sent base64 encoded. By default the server only supports the verbs verify, quit and selftest. Verbs are sent first followed by a newline \textbackslash{n}. May proceed by a payload and an end string \textbf{[[DAFNY-CLIENT: EOM]]}. \newline 
Verb explanation: Verify needs a verification task and returns if all proofs holds, quit stops the server and selftest execute some simple verification. \newline

\textbf{Example verification task}
\begin{lstlisting}[language=json,firstnumber=1]
{
	args:[],
	filename:"c:\Users\Markus\Desktop\dafny\test1.dfy",
	source:"method Main() {	assert 1 < 3; }",
	sourceIsFile:false
}

\end{lstlisting}

\subsubsection{symbols}
To support refactorings in the Dafny VSCode plugin, symbol information were needed. All fields, methods and classes inside a file with their information about position, reference and usage have to be accessible. To support that the DafnyServer was extended. A new verb "symbols" was introduced. This collects various information about the SymbolTable of the input file and returns it as json. 
\newline\newline
\textbf{Request: }

\begin{lstlisting}[language=dafny]
class BankAccountUnsafe {
  var balance: int;
  constructor() modifies this { 
    balance := 10;
  }
  
  method withdraw(amount: int) 
    modifies this
    requires amount >= 0
  {   
    balance := balance - amount; 
  } 
}   

method test() { 
  var a := new BankAccountUnsafe(); 
  a.withdraw(9);  
}   
\end{lstlisting}

\textbf{Result: }
\begin{lstlisting}[language=json,firstnumber=1]
[ 
....
{
  "Call" : null,
  "Column" : 3,
  "EndColumn" : null,
  "EndLine" : null,
  "EndPosition" : null,
  "Ensures" : [],
  "Line" : 3,
  "Module" : "_module",
  "Name" : "_ctor",
  "ParentClass" : "BankAccountUnsafe",
  "Position" : 49,
  "References" : [{
    "Column" : 12,
    "Line" : 15,
    "MethodName" : "test",
    "Position" : 265,
    "ReferencedName" : "_ctor"
  }],
  "Requires" : [],
  "SymbolType" : "Method"
}, {
  "Call" : null,
  "Column" : 9,
  "EndColumn" : null,
  "EndLine" : null,
  "EndPosition" : null,
  "Ensures" : [],
  "Line" : 6,
  "Module" : "_module",
  "Name" : "withdraw",
  "ParentClass" : "BankAccountUnsafe",
  "Position" : 114,
  "References" : [{
    "Column" : 5,
    "Line" : 16,
    "MethodName" : "test",
    "Position" : 296,
    "ReferencedName" : "withdraw"
  }],
  "Requires" : ["amount >= 0"],
  "SymbolType" : "Method"
}, {
  "Call" : null,
  "Column" : 6,
  "EndColumn" : null,
  "EndLine" : null,
  "EndPosition" : null,
  "Ensures" : null,
  "Line" : 2,
  "Module" : "_module",
  "Name" : "balance",
  "ParentClass" : "BankAccountUnsafe",
  "Position" : 32,
  "References" : [{
    "Column" : 5,
    "Line" : 4,
    "MethodName" : "balance",
    "Position" : 85,
    "ReferencedName" : "balance"
  }, {
    "Column" : 3,
    "Line" : 10,
    "MethodName" : "balance",
    "Position" : 190,
    "ReferencedName" : "balance"
  }, {
    "Column" : 14,
    "Line" : 10,
    "MethodName" : "balance",
    "Position" : 201,
    "ReferencedName" : "balance"
  }],
  "Requires" : null,
  "SymbolType" : "Field"
}
.... 
]
\end{lstlisting}



\subsubsection{versioncheck}
To support automatically updates of the Dafny environment in a general approach, it was decided to implement this features directly into the DafnyServer. To make it as general as possible the check is directly performed on release page of the dafny project. The GitHub api allows to check that in just one call. Additionally a semantic versioning library\cite{semver} was used to compare the current and the version from GitHub. Based on that check either there is a update available or the latest version is installed. If there is a update available the url to download the package can also be read out of the returned json. 
\newline
\textbf{Response from GitHub}
\begin{lstlisting}[language=json,firstnumber=1]
[{
  "name" : "v1.9.12",
  "assets" : [{
    "name" : "dafny-1.9.12-x64-osx-10.11.6.zip",
    "browser_download_url" : "https://github.com/FunctionalCorrectness/dafny-microsoft/releases/download/v1.9.12/dafny-1.9.12-x64-osx-10.11.6.zip"
  }, {
    "name" : "dafny-1.9.12-x64-ubuntu-14.04.zip",
    "browser_download_url" : "https://github.com/FunctionalCorrectness/dafny-microsoft/releases/download/v1.9.12/dafny-1.9.12-x64-ubuntu-14.04.zip"
  }, {
    "name" : "dafny-1.9.12-x64-win.zip",
    "browser_download_url" : "https://github.com/FunctionalCorrectness/dafny-microsoft/releases/download/v1.9.12/dafny-1.9.12-x64-win.zip"
  }]
}]
\end{lstlisting}

Currently the check is performed against the url:  \href{https://api.github.com/repos/FunctionalCorrectness/dafny-microsoft/releases}{https://api.github.com/repos/FunctionalCorrectness/dafny-microsoft/releases} which have to be changed as soon as the pull request is performed. 


\subsubsection{version}
The command returns the version of the DafnyServer.  


\subsection{Dafny}

\subsubsection{Unicode}
Dafny would support the following unicode characters: 

\rowcolors{2}{gray!25}{white}
\begin{longtable}[H]
	{l|p{0.22\textwidth}| p{0.22\textwidth} | p{0.1\textwidth} | p{0.1\textwidth} | p{0.25\textwidth} | p{0.25\textwidth}}
	
	\textbf{Ascii} & \textbf{Unicode}  \\ \hline
	<==> & u21d4  \\  
	==> & u21d2  \\  
	<== & u21d0  \\  
	\&\& & u2227  \\  
	| | & u2228  \\  
	!= & u2260  \\  
	<= & u2264  \\  
	>= & u2265  \\  
	:: & u2022  \\  
	! & u00ac  \\  
	forall & u2200  \\  
	exists & u2203  
	
	
\end{longtable}

Unfortunately they are not working right know, because of a bug in the parser.


\subsection{Eclipse integration}
The eclipse project \href{https://projects.eclipse.org/projects/technology.lsp4e}{LSP4E} aims to integrate existing language servers into the Eclipse IDE in a easy way. 
\newline
"It includes some APIs to turn language server protocol elements into Eclipse IDE concepts and a generic integration allowing to easily plug any language server to an Eclipse IDE instance without need to write Java code, either via a plugin associating a new language server, and by letting users manually bind language servers to their IDE." \cite{lsp4e}

It is built on top of \href{https://github.com/eclipse/lsp4j}{LSP4J} a java implementation of the language server protocol. 
\newline
Integrating the VSCode Dafny language server into eclipse could became possible in the future. Right know there is no way to interact on the client side as well. You only can specify a language server based on a program (NodeJS) and arguments (extension.js) which is executed and used for querying information. You can't add any behaviour to Eclipse itself, which would be necessary for certain features. Also the sendRequest isn't implemented yet (Commit: 1615e07), which is important for starting the DafnyServer correctly. 
The better way would be to program a new eclipse plugin, based on LSP4J which then would also allow to customize the statusbar, run scripts and show progress information. 




