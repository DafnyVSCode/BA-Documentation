\section{Dafny VSCode}
Github Repository: \href{https://github.com/FunctionalCorrectness/dafny-vscode}{https://github.com/FunctionalCorrectness/dafny-vscode}

\subsection{Overview}
\todo{Maybe add a class diagram}

\subsection{VSCode Plugin}
\subsubsection{Structure}
\todo{How is a vscode plugin structured, package.json explaination}


\input{sections/languageserver}

\subsection{Extension points}

\paragraph{Statusbar}

\paragraph{Refactoring}

\paragraph{CodeLens}

\paragraph{Go to definition}

\paragraph{Debugger}
\todo{Boogie Verification Debugger: Why BVD can't be used directly: C sharp UI, }

\subsection{Communication}

\subsection{Sytax highlighting}

\subsection{Snippets}

\subsection{Automatic installation}
\subsubsection{Windows}

\subsubsection{Ubuntu}

\subsubsection{OSX}


\subsection{DafnyServer}
Github Repository: \href{https://github.com/FunctionalCorrectness/dafny-microsoft}{https://github.com/FunctionalCorrectness/dafny-microsoft}

The DafnyServer is a simple console application which allows proofing Dafny source files. To verify files, they are sent over the standard input. Results are obtained from the standard output. The verification task needs to be in json format \todo{add reference to source.cs} and is sent base64 encoded. By default the server only supports the verbs verify, quit and selftest. Verbs are sent first followed by a newline \textbackslash{n}. May proceed by a payload and an end string \todo{reference to end string}. 
Verb explanation: Verify needs a verification task and returns if all proofs holds, quit stops the server and selftest execute some simple verification. 

\textbf{Example verification task}
\begin{lstlisting}[language=json,firstnumber=1]
{
	args:[],
	filename:"c:\Users\Markus\Desktop\dafny\test1.dfy",
	source:"method Main() {	assert 1 < 3; }",
	sourceIsFile:false
}

\end{lstlisting}

\subsubsection{symbols}
To support refactorings in the Dafny VSCode plugin, symbol information were needed. All fields, methods and classes inside a file with their position information needed to be accessible. To support that the DafnyServer was extended. A new verb "symbols" was introduced. This returns a json formatted symbol table, of the input file. 
\newline\newline
\textbf{Request: }
\todonl{add request}
\newline\newline
\textbf{Result: }
\begin{lstlisting}[language=json,firstnumber=1]
{[
{
	"Module" : "_module",
	"Name" : "Fibonacci",
	"ParentClass" : "_default",
	"SymbolType" : "Function",
	"Position" : 190,
	"Line" : 17,
	"Column" : 12
}, {
	"Module" : "_module",
	"Name" : "Test",
	"ParentClass" : null,
	"SymbolType" : "Class",
	"Position" : 8,
	"Line" : 2,
	"Column" : 7
}, {
	"Module" : "_module",
	"Name" : "_default",
	"ParentClass" : null,
	"SymbolType" : "Class",
	"Position" : 0,
	"Line" : 0,
	"Column" : 0
}
]}
\end{lstlisting}

\subsubsection{references}
To support CodeLens in the plugin, it was also necessary to get all method references from a given one. To also allow that the verb "references" was also introduced. This task finds all call statements towards a specified method. This has to be specified in the args argument, with the following information: [moduleName, className, methodName]. 
\newline\newline
\textbf{Request: }
\todonl{add request}
\newline\newline
\textbf{Result: }
\begin{lstlisting}[language=json,firstnumber=1]
[{
	"MethodName":"Main3",
	"Position":226,
	"Line":18,
	"Column":8
}] 
\end{lstlisting}


\subsubsection{proofs}
\textbf{Request: }
\begin{lstlisting}[language=json,firstnumber=1]
\todo{Add request}
\end{lstlisting}

\textbf{Result: }
\begin{lstlisting}[language=json,firstnumber=1]
[
	{
		"Proof" : "a#0 != null",
		"Type" : "Assert"
	}, {
		"Proof" : "$w$loop#0 ==> i#0 <= N#0",
		"Type" : "Assert"
	}, {
		"Proof" : "$w$loop#0 ==> sum#0 <= i#0 * max#0",
		"Type" : "Assert"
	}, {
		"Proof" : "a#0 != null",
		"Type" : "Assert"
	}, {
		"Proof" : "0 <= i#0 && i#0 < _System.array.Length(a#0)",
		"Type" : "Assert"
	}, {
		"Proof" : "a#0 != null",
		"Type" : "Assert"
	}, {
		"Proof" : "0 <= i#0 && i#0 < _System.array.Length(a#0)",
		"Type" : "Assert"
	}, {
		"Proof" : "a#0 != null",
		"Type" : "Assert"
	}, {
		"Proof" : "0 <= i#0 && i#0 < _System.array.Length(a#0)",
		"Type" : "Assert"
	}, {
		"Proof" : "0 <= $decr$loop#00 || N#0 - i#0 == $decr$loop#00",
		"Type" : "Assert"
	}, {
		"Proof" : "N#0 - i#0 < $decr$loop#00",
		"Type" : "Assert"
	}
]
\end{lstlisting}



\subsection{Dafny}

\subsubsection{Unicode}
Dafny would support the following unicode characters: 

\rowcolors{2}{gray!25}{white}
\begin{longtable}[H]
	{l|p{0.22\textwidth}| p{0.22\textwidth} | p{0.1\textwidth} | p{0.1\textwidth} | p{0.25\textwidth} | p{0.25\textwidth}}
	
	\textbf{Ascii} & \textbf{Unicode}  \\ \hline
	<==> & u21d4  \\  
	==> & u21d2  \\  
	<== & u21d0  \\  
	\&\& & u2227  \\  
	| | & u2228  \\  
	!= & u2260  \\  
	<= & u2264  \\  
	>= & u2265  \\  
	:: & u2022  \\  
	! & u00ac  \\  
	forall & u2200  \\  
	exists & u2203  
	
	
\end{longtable}

Unfortunately they are not working right know, because of a bug in the parser.


\subsection{Eclipse integration}
The eclipse project \href{https://projects.eclipse.org/projects/technology.lsp4e}{LSP4E} aims to integrate existing language servers into the Eclipse IDE in a easy way. 
\newline
"It includes some APIs to turn language server protocol elements into Eclipse IDE concepts and a generic integration allowing to easily plug any language server to an Eclipse IDE instance without need to write Java code, either via a plugin associating a new language server, and by letting users manually bind language servers to their IDE." \cite{lsp4e}

It is built on top of \href{https://github.com/eclipse/lsp4j}{LSP4J} a java implementation of the language server protocol. 
\newline
Integrating the VSCode Dafny language server into eclipse could became possible in the future. Right know there is no way to interact on the client side as well. You only can specify a language server based on a program (NodeJS) and arguments (extension.js) which is executed and used for querying information. You can't add any behaviour to Eclipse itself, which would be necessary for certain features. Also the sendRequest isn't implemented yet (Commit: 1615e07), which is important for starting the DafnyServer correctly. 
The better way would be to program a new eclipse plugin, based on LSP4J which then would also allow to customize the statusbar, run scripts and show progress information. 




